name: Sync Fork Dev with Upstream Master

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at UTC midnight
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required to push code changes
  actions: write  # Required to modify workflow files

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository with token for authentication
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Checkout all history
          token: ${{ secrets.GITHUB_TOKEN }}

      # Set git identity
      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "418982+github-actions[bot]@users.noreply.github.com"

      # Check if dev branch exists, create if needed
      - name: Check and create dev branch if needed
        run: |
          if git checkout dev 2>/dev/null; then
            echo "✅ dev branch exists, switched to dev branch"
          else
            echo "❌ dev branch does not exist, creating from main branch"
            git checkout main
            git checkout -b dev
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git dev
            echo "✅ Successfully created and pushed dev branch"
          fi

      # Add upstream repository
      - name: Add upstream repository
        run: git remote add upstream https://github.com/RealKai42/qwerty-learner.git || echo "Upstream repository already exists"

      # Fetch latest changes from upstream
      - name: Fetch upstream changes
        run: git fetch upstream --prune

      # Force reset local dev branch to match upstream master
      - name: Force reset local dev branch to match upstream master
        run: git reset --hard upstream/master

      # Force push changes to fork repository
      - name: Force push changes to fork repository
        run: |
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git dev --force

      # Log sync status
      - name: Log sync status
        if: ${{ success() }}
        run: |
          echo "✅ Successfully synced with upstream repository!"
          echo "Local dev branch has been reset to match upstream master branch"

      - name: Log sync failure
        if: ${{ failure() }}
        run: |
          echo "❌ Failed to sync with upstream repository!"
          echo "Please check Actions logs for details."

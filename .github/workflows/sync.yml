name: Sync Fork Main with Upstream Master

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 0 ç‚¹æ‰§è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºæ‚¨çš„forkä»“åº“çš„mainåˆ†æ”¯
      - name: Checkout fork repository
        uses: actions/checkout@v3
        with:
          ref: main
          persist-credentials: false

      # é…ç½®Gitèº«ä»½
      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "418982+github-actions[bot]@users.noreply.github.com"

      # æ·»åŠ åŸä»“åº“ä½œä¸ºä¸Šæ¸¸ä»“åº“
      - name: Add upstream repository
        run: git remote add upstream https://github.com/RealKai42/qwerty-learner.git

      # è·å–åŸä»“åº“çš„æœ€æ–°ä»£ç 
      - name: Fetch upstream changes
        run: git fetch upstream --prune

      # é…ç½®Gitåˆå¹¶ç­–ç•¥ï¼ˆè§£å†³åˆ†æ”¯åˆ†æ­§é—®é¢˜ï¼‰
      - name: Configure git merge strategy
        run: git config pull.rebase false  # ä½¿ç”¨mergeç­–ç•¥ï¼Œå®‰å…¨ä¸”ç¨³å®š

      # åˆå¹¶åŸä»“åº“masteråˆ†æ”¯çš„æ›´æ–°åˆ°æœ¬åœ°mainåˆ†æ”¯
      - name: Merge upstream master into local main
        run: git pull upstream master --no-edit

      # å°†æ›´æ–°æ¨é€åˆ°æ‚¨çš„forkä»“åº“mainåˆ†æ”¯
      - name: Push changes to fork repository
        run: git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Send failure notification
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»“åº“å¤±è´¥',
              body: 'è‡ªåŠ¨åŒæ­¥åŸä»“åº“ï¼ˆRealKai42/qwerty-learnerï¼‰masteråˆ†æ”¯åˆ°æœ¬ä»“åº“mainåˆ†æ”¯çš„å·¥ä½œæµæ‰§è¡Œå¤±è´¥ã€‚è¯·æŸ¥çœ‹Actionsæ—¥å¿—äº†è§£è¯¦æƒ…ã€‚'
            })

      # æˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Send success notification
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          script: |
            // ä»…åœ¨æœ‰å®é™…æ›´æ–°æ—¶å‘é€é€šçŸ¥
            const diff = await exec.getExecOutput('git', ['log', 'origin/main..main', '--oneline']);
            if (diff.stdout.trim().length > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âœ… æˆåŠŸåŒæ­¥ä¸Šæ¸¸ä»“åº“æ›´æ–°',
                body: 'å·²æˆåŠŸä»åŸä»“åº“ï¼ˆRealKai42/qwerty-learnerï¼‰masteråˆ†æ”¯åŒæ­¥æœ€æ–°æ›´æ–°åˆ°æœ¬ä»“åº“mainåˆ†æ”¯ã€‚\n\næ›´æ–°å†…å®¹ï¼š\n```\n' + diff.stdout + '\n```'
              });
            }

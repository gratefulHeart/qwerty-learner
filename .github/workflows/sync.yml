name: Sync Fork Main with Upstream Master

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 时间 0 点执行
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write  # 授予写入内容的权限

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 检出您的fork仓库的main分支
      - name: Checkout fork repository
        uses: actions/checkout@v3
        with:
          ref: main
          persist-credentials: false

      # 配置Git身份
      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "418982+github-actions[bot]@users.noreply.github.com"

      # 添加原仓库作为上游仓库
      - name: Add upstream repository
        run: git remote add upstream https://github.com/RealKai42/qwerty-learner.git

      # 获取原仓库的最新代码
      - name: Fetch upstream changes
        run: git fetch upstream --prune

      # 配置Git合并策略
      - name: Configure git merge strategy
        run: git config pull.rebase false

      # 合并原仓库master分支的更新到本地main分支（允许不相关历史）
      - name: Merge upstream master into local main
        run: git pull upstream master --no-edit --allow-unrelated-histories

      # 将更新推送到您的fork仓库main分支
      - name: Push changes to fork repository
        run: git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 可选的日志输出，不涉及创建issue
      - name: Log sync status
        if: ${{ success() }}
        run: |
          echo "✅ 成功同步上游仓库更新！"
          # 查看有哪些更新（可选）
          git log origin/main..main --oneline || echo "没有新的更新需要同步。"

      - name: Log sync failure
        if: ${{ failure() }}
        run: |
          echo "❌ 同步上游仓库失败！"
          echo "请查看Actions日志了解详情。"

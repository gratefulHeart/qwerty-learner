name: Sync Fork Main with Upstream Master

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 时间 0 点执行
  workflow_dispatch:  # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 检出您的fork仓库的main分支
      - name: Checkout fork repository
        uses: actions/checkout@v3
        with:
          ref: main
          persist-credentials: false

      # 配置Git身份
      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "418982+github-actions[bot]@users.noreply.github.com"

      # 添加原仓库作为上游仓库
      - name: Add upstream repository
        run: git remote add upstream https://github.com/RealKai42/qwerty-learner.git

      # 获取原仓库的最新代码
      - name: Fetch upstream changes
        run: git fetch upstream --prune

      # 配置Git合并策略（解决分支分歧问题）
      - name: Configure git merge strategy
        run: git config pull.rebase false  # 使用merge策略，安全且稳定

      # 合并原仓库master分支的更新到本地main分支
      - name: Merge upstream master into local main
        run: git pull upstream master --no-edit

      # 将更新推送到您的fork仓库main分支
      - name: Push changes to fork repository
        run: git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 失败通知（可选）
      - name: Send failure notification
        if: ${{ failure() }}
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '🔄 同步上游仓库失败',
              body: '自动同步原仓库（RealKai42/qwerty-learner）master分支到本仓库main分支的工作流执行失败。请查看Actions日志了解详情。'
            })

      # 成功通知（可选）
      - name: Send success notification
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          script: |
            // 仅在有实际更新时发送通知
            const diff = await exec.getExecOutput('git', ['log', 'origin/main..main', '--oneline']);
            if (diff.stdout.trim().length > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '✅ 成功同步上游仓库更新',
                body: '已成功从原仓库（RealKai42/qwerty-learner）master分支同步最新更新到本仓库main分支。\n\n更新内容：\n```\n' + diff.stdout + '\n```'
              });
            }
